<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>faicker&#39;s个人博客</title>
  <subtitle>关注云计算，网络虚拟化</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.motitan.com/"/>
  <updated>2017-08-22T09:53:02.000Z</updated>
  <id>http://blog.motitan.com/</id>
  
  <author>
    <name>faicker</name>
    <email>faicker.mo@gmail.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ovn学习-1</title>
    <link href="http://blog.motitan.com/2017/08/22/ovn%E5%AD%A6%E4%B9%A0-1/"/>
    <id>http://blog.motitan.com/2017/08/22/ovn学习-1/</id>
    <published>2017-08-22T10:00:00.000Z</published>
    <updated>2017-08-22T09:53:02.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="配置同步协议（sequence-number-protocol）"><a href="#配置同步协议（sequence-number-protocol）" class="headerlink" title="配置同步协议（sequence number protocol）"></a>配置同步协议（sequence number protocol）</h2><p>ovn各个进程间都是通过ovsdb交互的。怎么知道一个命令是否执行成功了呢。比如<code>ovn-nbctl -v --wait=hv acl-add dmz to-lport 100 tcp.dst==23 allow-related</code>。  </p>
<p>协议工作过程如下，</p>
<ol>
<li><code>NB_Global</code>表里的<code>nb_cfg</code>加1</li>
<li>当<code>ovn-northd</code>更新sb db时，把<code>NB_Global</code>表里的<code>nb_cfg</code>的值拷贝到<code>SB_Global</code>里。（从这里可以确认sb db是否与nb db一致）</li>
<li>在<code>ovn-northd</code>从sb db收到确认后，更新<code>NB_Global</code>表里的<code>sb_cfg</code>，使得<code>sb_cfg=nb_cfg</code></li>
<li>在<code>chassis</code>上的<code>ovn-controller</code>收到更新的带有<code>nb_cfg</code>的sb db时，更新ovs里的flow。当从ovs收到更新完成的消息后，在sb db里更新自己的<code>chassis</code>的<code>nb_cfg</code>的值。</li>
<li><code>ovn-northd</code>监控sb db里<code>Chassis</code>表里的<code>nb_cfg</code>列，copy这个值到<code>NB_Global</code>表里的<code>hv_cfg</code>。（从这里可以确认是否所有的<code>hypervisor</code>跟nb db一致）</li>
</ol>
<h2 id="接口生命周期"><a href="#接口生命周期" class="headerlink" title="接口生命周期"></a>接口生命周期</h2><ol>
<li>CMS（ovn-nbctl）创建逻辑接口，并更新配置。包括vif-id和mac。</li>
<li>CMS（ovn-nbctl）更新nb db，在<code>Logical_Switch_Port</code>添加一行，指定了vif-id, mac, <code>Logical_Switch</code>的值。</li>
<li><code>ovn-northd</code>收到db更新的通知后，更新sb db。在<code>Logical_Flow</code>表里增加flow，在Binding表里生成记录。</li>
<li>在每一个hypervisor上，ovn-controller收到了sb db的更新通知，如果接口是down的，ovn-controller做不了很多事情。</li>
<li>接口UP后，hypervisor（比如libvirt）把接口加入bridge，并且设置<code>external_ids:iface-id=vif-id</code>。</li>
<li>ovn-controller收到这个iface-id通知后，更新sb db里的Binding表里的Chassis值，更新本地的flow。</li>
<li>对于像openstack，当网络初始化好后才完全启动VM的情况，ovn-northd在知道Binding表里的Chassis值更新后，再更新<code>Logical_Switch_Port</code>里的up列。</li>
<li>在其他hypervisor上，ovn-controller也能收到sb db（Chassis）的通知，然后知道了这个逻辑端口的物理位置，更新本地的flow。</li>
<li>VM关机，VIF从br删掉。</li>
<li>在VM关机的hypervisor上，ovn-controller知道VIF被删除后，删除Binding表里对应逻辑端口的Chassis值。</li>
<li>在每一个hypervisor上，ovn-controller知道了Binding表里的逻辑端口的Chassis值被清空，意味着ovn-controller不再知道逻辑端口的物理位置了，更新本地的flow。</li>
<li>最后，VIF或者是VM不再需要了，就可以通过CMS删掉。</li>
<li>CMS plugin从nb db里删除<code>Logical_Switch_Port</code>表的VIF数据。</li>
<li>ovn-northd接收到nb db更新后，更新sb db（包括<code>Logical_Flow</code>表和<code>Binding</code>表）。</li>
<li>在每一个hypervisor上，ovn-controller接收到sb db更新后，删除或者更新本地flow。</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;配置同步协议（sequence-number-protocol）&quot;&gt;&lt;a href=&quot;#配置同步协议（sequence-number-protocol）&quot; class=&quot;headerlink&quot; title=&quot;配置同步协议（sequence number proto
    
    </summary>
    
      <category term="ovn" scheme="http://blog.motitan.com/categories/ovn/"/>
    
      <category term="openvswitch" scheme="http://blog.motitan.com/categories/ovn/openvswitch/"/>
    
    
      <category term="openvswitch" scheme="http://blog.motitan.com/tags/openvswitch/"/>
    
      <category term="ovn" scheme="http://blog.motitan.com/tags/ovn/"/>
    
      <category term="ovs" scheme="http://blog.motitan.com/tags/ovs/"/>
    
  </entry>
  
  <entry>
    <title>ovn学习-2</title>
    <link href="http://blog.motitan.com/2017/08/22/ovn%E5%AD%A6%E4%B9%A0-2/"/>
    <id>http://blog.motitan.com/2017/08/22/ovn学习-2/</id>
    <published>2017-08-22T10:00:00.000Z</published>
    <updated>2017-08-22T11:00:16.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ovsdb协议"><a href="#ovsdb协议" class="headerlink" title="ovsdb协议"></a>ovsdb协议</h2><ul>
<li>基于json的RPC</li>
<li>协议定义参考 <a href="https://www.rfc-editor.org/rfc/rfc7047.txt" target="_blank" rel="external">https://www.rfc-editor.org/rfc/rfc7047.txt</a></li>
<li>当前ovsdb-server实现是单线程，性能很低，HA只有主备。</li>
</ul>
<h2 id="client库"><a href="#client库" class="headerlink" title="client库"></a>client库</h2><p>自带 C 和 Python的。其他开源的库有</p>
<ul>
<li>golang<br><code>https://github.com/socketplane/libovsdb/blob/master/example/play_with_ovs.go</code><br><code>https://github.com/contiv/ofnet/blob/master/ovsdbDriver/ovsdbDriver.go</code></li>
<li>python<br>ovsdbapp</li>
</ul>
<p>以下是一个ovsdbapp使用的例子，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> ovsdbapp.backend.ovs_idl <span class="keyword">import</span> connection</div><div class="line"><span class="keyword">from</span> ovsdbapp <span class="keyword">import</span> constants</div><div class="line"><span class="keyword">from</span> ovsdbapp.schema.open_vswitch <span class="keyword">import</span> impl_idl</div><div class="line"></div><div class="line"></div><div class="line">ovsdb_connection = connection.Connection(</div><div class="line">    idl=connection.OvsdbIdl.from_server(</div><div class="line">        <span class="string">'unix:/var/run/openvswitch/db.sock'</span>, <span class="string">'Open_vSwitch'</span>),</div><div class="line">    timeout=constants.DEFAULT_TIMEOUT)</div><div class="line"></div><div class="line">api = impl_idl.OvsdbIdl(ovsdb_connection)</div><div class="line">result = api.br_exists(<span class="string">"br0"</span>).execute(check_error=<span class="keyword">True</span>)</div><div class="line"><span class="keyword">print</span> result</div><div class="line">result = api.del_br(<span class="string">"br1"</span>).execute(check_error=<span class="keyword">True</span>)</div><div class="line"><span class="keyword">print</span> result</div></pre></td></tr></table></figure>
<h2 id="协议交互举例"><a href="#协议交互举例" class="headerlink" title="协议交互举例"></a>协议交互举例</h2><p>ovs-vsctl操作的是ovs db。ovs-vswitchd有monitor ovs db，ovs db的变更都会发到ovs-vswitchd。ovs-vsctl和ovs-vswitchd都是通过ovsdb-server进程（unix socket或者是tcp连接）去watch或者update db的。</p>
<p>以<code>ovs-vsctl add-port br0 abc -- set interface abc type=internal</code>为例，<br>ovs-vsctl会在ovsdb的Port表和Interface表增加一行数据，ovs-vswitchd收到通知后，会创建接口，并且把ofport，mtu，mac，link_state等信息写入Interface表里。写入是否成功呢，还是靠的监控通知机制。</p>
<p><code>ovs-vsctl -v</code>可以打印出ovs-vsctl和ovsdb-server详细的json rpc交互过程。</p>
<p><code>ovsdb-client monitor tcp:127.0.0.1:6640 Interface name,ofport,external_ids --format=json</code>这个命令可以watch某些表某些字段的变更通知：</p>
<pre><code>1. 初始时会把所有的内容返回来。
2. 以后只会返回变化的。
3. 注意，返回的action里有initial，delete, new不是实际协议的内容，这是处理过了的。协议里只有old和new。见rfc里的4.1.6里的解释。
</code></pre><p>ovs-vswitchd消息处理过程如下，</p>
<a id="more"></a>
<ul>
<li>收到update通知消息，</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line">[<span class="literal">null</span>, &#123;</div><div class="line">    <span class="attr">"Port"</span>: &#123;</div><div class="line">        <span class="attr">"5943a115-162f-484f-8e45-5cbf9cd112c5"</span>: &#123;</div><div class="line">            <span class="attr">"new"</span>: &#123;</div><div class="line">                <span class="attr">"name"</span>: <span class="string">"abc"</span>,</div><div class="line">                <span class="attr">"statistics"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"vlan_mode"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"qos"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"trunks"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"mac"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"status"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"interfaces"</span>: [<span class="string">"uuid"</span>, <span class="string">"9fb84aa6-ac6e-4575-b4e7-0cc87c755195"</span>],</div><div class="line">                <span class="attr">"bond_downdelay"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"bond_mode"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"bond_updelay"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"other_config"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"bond_fake_iface"</span>: <span class="literal">false</span>,</div><div class="line">                <span class="attr">"tag"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"fake_bridge"</span>: <span class="literal">false</span>,</div><div class="line">                <span class="attr">"lacp"</span>: [<span class="string">"set"</span>, []]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"Bridge"</span>: &#123;</div><div class="line">        <span class="attr">"3d081a41-f691-41a6-a469-d0a0100fbf8c"</span>: &#123;</div><div class="line">            <span class="attr">"old"</span>: &#123;</div><div class="line">                <span class="attr">"ports"</span>: [<span class="string">"set"</span>, [</div><div class="line">                    [<span class="string">"uuid"</span>, <span class="string">"10c55211-94b2-4bc7-aefb-e524c3f1f7eb"</span>],</div><div class="line">                    [<span class="string">"uuid"</span>, <span class="string">"421029b9-2467-4946-bece-1e408524a2f9"</span>]</div><div class="line">                ]]</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"new"</span>: &#123;</div><div class="line">                <span class="attr">"name"</span>: <span class="string">"br0"</span>,</div><div class="line">                <span class="attr">"flood_vlans"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"netflow"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"mirrors"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"status"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"datapath_id"</span>: <span class="string">"0000421a083da641"</span>,</div><div class="line">                <span class="attr">"controller"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ipfix"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"protocols"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"fail_mode"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ports"</span>: [<span class="string">"set"</span>, [</div><div class="line">                    [<span class="string">"uuid"</span>, <span class="string">"10c55211-94b2-4bc7-aefb-e524c3f1f7eb"</span>],</div><div class="line">                    [<span class="string">"uuid"</span>, <span class="string">"421029b9-2467-4946-bece-1e408524a2f9"</span>],</div><div class="line">                    [<span class="string">"uuid"</span>, <span class="string">"5943a115-162f-484f-8e45-5cbf9cd112c5"</span>]</div><div class="line">                ]],</div><div class="line">                <span class="attr">"other_config"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"flow_tables"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"sflow"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"datapath_type"</span>: <span class="string">""</span>,</div><div class="line">                <span class="attr">"stp_enable"</span>: <span class="literal">false</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"Interface"</span>: &#123;</div><div class="line">        <span class="attr">"9fb84aa6-ac6e-4575-b4e7-0cc87c755195"</span>: &#123;</div><div class="line">            <span class="attr">"new"</span>: &#123;</div><div class="line">                <span class="attr">"name"</span>: <span class="string">"abc"</span>,</div><div class="line">                <span class="attr">"options"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"mtu"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"link_speed"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"statistics"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"mac_in_use"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"internal"</span>,</div><div class="line">                <span class="attr">"cfm_remote_opstate"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ingress_policing_rate"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"status"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"mac"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ofport"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ifindex"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"cfm_fault_status"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"duplex"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"lacp_current"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"cfm_fault"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"bfd_status"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"link_state"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"admin_state"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"other_config"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"cfm_remote_mpids"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ingress_policing_burst"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"ofport_request"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"bfd"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"cfm_mpid"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"cfm_flap_count"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"link_resets"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"cfm_health"</span>: [<span class="string">"set"</span>, []]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"Open_vSwitch"</span>: &#123;</div><div class="line">        <span class="attr">"099e083f-aa09-4dd1-95d2-d0b4857eb3b9"</span>: &#123;</div><div class="line">            <span class="attr">"old"</span>: &#123;</div><div class="line">                <span class="attr">"next_cfg"</span>: <span class="number">70</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"new"</span>: &#123;</div><div class="line">                <span class="attr">"statistics"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"manager_options"</span>: [<span class="string">"uuid"</span>, <span class="string">"28542e8a-9886-4282-8b43-afb5b80c0cc5"</span>],</div><div class="line">                <span class="attr">"bridges"</span>: [<span class="string">"set"</span>, [</div><div class="line">                    [<span class="string">"uuid"</span>, <span class="string">"3d081a41-f691-41a6-a469-d0a0100fbf8c"</span>],</div><div class="line">                    [<span class="string">"uuid"</span>, <span class="string">"558db8c8-bc39-4781-a441-f58e7dc6a951"</span>]</div><div class="line">                ]],</div><div class="line">                <span class="attr">"other_config"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"ssl"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"next_cfg"</span>: <span class="number">71</span>,</div><div class="line">                <span class="attr">"cur_cfg"</span>: <span class="number">70</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;]</div></pre></td></tr></table></figure>
<ul>
<li>创建接口，<code>bridge br0: added interface abc on port 10</code></li>
<li>更新ovsdb，</li>
</ul>
<p>发送transact请求1，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[<span class="string">"Open_vSwitch"</span>, &#123;</div><div class="line">    <span class="attr">"lock"</span>: <span class="string">"ovs_vswitchd"</span>,</div><div class="line">    <span class="attr">"op"</span>: <span class="string">"assert"</span></div><div class="line">&#125;, &#123;</div><div class="line">    <span class="attr">"row"</span>: &#123;</div><div class="line">        <span class="attr">"ofport"</span>: <span class="number">10</span>,</div><div class="line">        <span class="attr">"statistics"</span>: [<span class="string">"map"</span>, [</div><div class="line">            [<span class="string">"collisions"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"rx_bytes"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"rx_crc_err"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"rx_dropped"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"rx_errors"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"rx_frame_err"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"rx_over_err"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"rx_packets"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"tx_bytes"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"tx_dropped"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"tx_errors"</span>, <span class="number">0</span>],</div><div class="line">            [<span class="string">"tx_packets"</span>, <span class="number">0</span>]</div><div class="line">        ]]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"table"</span>: <span class="string">"Interface"</span>,</div><div class="line">    <span class="attr">"where"</span>: [</div><div class="line">        [<span class="string">"_uuid"</span>, <span class="string">"=="</span>, [<span class="string">"uuid"</span>, <span class="string">"9fb84aa6-ac6e-4575-b4e7-0cc87c755195"</span>]]</div><div class="line">    ],</div><div class="line">    <span class="attr">"op"</span>: <span class="string">"update"</span></div><div class="line">&#125;, &#123;</div><div class="line">    <span class="attr">"row"</span>: &#123;</div><div class="line">        <span class="attr">"cur_cfg"</span>: <span class="number">71</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"table"</span>: <span class="string">"Open_vSwitch"</span>,</div><div class="line">    <span class="attr">"where"</span>: [</div><div class="line">        [<span class="string">"_uuid"</span>, <span class="string">"=="</span>, [<span class="string">"uuid"</span>, <span class="string">"099e083f-aa09-4dd1-95d2-d0b4857eb3b9"</span>]]</div><div class="line">    ],</div><div class="line">    <span class="attr">"op"</span>: <span class="string">"update"</span></div><div class="line">&#125;]</div></pre></td></tr></table></figure>
<p>请求2，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[<span class="string">"Open_vSwitch"</span>, &#123;</div><div class="line">    <span class="attr">"lock"</span>: <span class="string">"ovs_vswitchd"</span>,</div><div class="line">    <span class="attr">"op"</span>: <span class="string">"assert"</span></div><div class="line">&#125;, &#123;</div><div class="line">    <span class="attr">"row"</span>: &#123;</div><div class="line">        <span class="attr">"status"</span>: [<span class="string">"map"</span>, [</div><div class="line">            [<span class="string">"driver_name"</span>, <span class="string">"openvswitch"</span>]</div><div class="line">        ]],</div><div class="line">        <span class="attr">"mtu"</span>: <span class="number">1500</span>,</div><div class="line">        <span class="attr">"mac_in_use"</span>: <span class="string">"6e:2b:1b:5e:23:8f"</span>,</div><div class="line">        <span class="attr">"link_state"</span>: <span class="string">"down"</span>,</div><div class="line">        <span class="attr">"link_resets"</span>: <span class="number">0</span>,</div><div class="line">        <span class="attr">"admin_state"</span>: <span class="string">"down"</span>,</div><div class="line">        <span class="attr">"ifindex"</span>: <span class="number">22</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"table"</span>: <span class="string">"Interface"</span>,</div><div class="line">    <span class="attr">"where"</span>: [</div><div class="line">        [<span class="string">"_uuid"</span>, <span class="string">"=="</span>, [<span class="string">"uuid"</span>, <span class="string">"9fb84aa6-ac6e-4575-b4e7-0cc87c755195"</span>]]</div><div class="line">    ],</div><div class="line">    <span class="attr">"op"</span>: <span class="string">"update"</span></div><div class="line">&#125;]</div></pre></td></tr></table></figure>
<ul>
<li>收到update通知消息（因为上面的update transact），</li>
</ul>
<p>update通知消息1，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">[<span class="literal">null</span>, &#123;</div><div class="line">    <span class="attr">"Interface"</span>: &#123;</div><div class="line">        <span class="attr">"9fb84aa6-ac6e-4575-b4e7-0cc87c755195"</span>: &#123;</div><div class="line">            <span class="attr">"old"</span>: &#123;</div><div class="line">                <span class="attr">"statistics"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"ofport"</span>: [<span class="string">"set"</span>, []]</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"new"</span>: &#123;</div><div class="line">                <span class="attr">"name"</span>: <span class="string">"abc"</span>,</div><div class="line">                <span class="attr">"options"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"mtu"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"link_speed"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"statistics"</span>: [<span class="string">"map"</span>, [</div><div class="line">                    [<span class="string">"collisions"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_bytes"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_crc_err"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_dropped"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_errors"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_frame_err"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_over_err"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_packets"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"tx_bytes"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"tx_dropped"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"tx_errors"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"tx_packets"</span>, <span class="number">0</span>]</div><div class="line">                ]],</div><div class="line">                <span class="attr">"mac_in_use"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"internal"</span>,</div><div class="line">                <span class="attr">"cfm_remote_opstate"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ingress_policing_rate"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"status"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"mac"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ofport"</span>: <span class="number">10</span>,</div><div class="line">                <span class="attr">"ifindex"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"cfm_fault_status"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"duplex"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"lacp_current"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"cfm_fault"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"bfd_status"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"link_state"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"admin_state"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"other_config"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"cfm_remote_mpids"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ingress_policing_burst"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"ofport_request"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"bfd"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"cfm_mpid"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"cfm_flap_count"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"link_resets"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"cfm_health"</span>: [<span class="string">"set"</span>, []]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"Open_vSwitch"</span>: &#123;</div><div class="line">        <span class="attr">"099e083f-aa09-4dd1-95d2-d0b4857eb3b9"</span>: &#123;</div><div class="line">            <span class="attr">"old"</span>: &#123;</div><div class="line">                <span class="attr">"cur_cfg"</span>: <span class="number">70</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"new"</span>: &#123;</div><div class="line">                <span class="attr">"statistics"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"manager_options"</span>: [<span class="string">"uuid"</span>, <span class="string">"28542e8a-9886-4282-8b43-afb5b80c0cc5"</span>],</div><div class="line">                <span class="attr">"bridges"</span>: [<span class="string">"set"</span>, [</div><div class="line">                    [<span class="string">"uuid"</span>, <span class="string">"3d081a41-f691-41a6-a469-d0a0100fbf8c"</span>],</div><div class="line">                    [<span class="string">"uuid"</span>, <span class="string">"558db8c8-bc39-4781-a441-f58e7dc6a951"</span>]</div><div class="line">                ]],</div><div class="line">                <span class="attr">"other_config"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"ssl"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"next_cfg"</span>: <span class="number">71</span>,</div><div class="line">                <span class="attr">"cur_cfg"</span>: <span class="number">71</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;]</div></pre></td></tr></table></figure>
<p>update通知消息2，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">[<span class="literal">null</span>, &#123;</div><div class="line">    <span class="attr">"Interface"</span>: &#123;</div><div class="line">        <span class="attr">"9fb84aa6-ac6e-4575-b4e7-0cc87c755195"</span>: &#123;</div><div class="line">            <span class="attr">"old"</span>: &#123;</div><div class="line">                <span class="attr">"status"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"mtu"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"mac_in_use"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"link_state"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"admin_state"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"link_resets"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ifindex"</span>: [<span class="string">"set"</span>, []]</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"new"</span>: &#123;</div><div class="line">                <span class="attr">"name"</span>: <span class="string">"abc"</span>,</div><div class="line">                <span class="attr">"options"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"mtu"</span>: <span class="number">1500</span>,</div><div class="line">                <span class="attr">"link_speed"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"statistics"</span>: [<span class="string">"map"</span>, [</div><div class="line">                    [<span class="string">"collisions"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_bytes"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_crc_err"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_dropped"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_errors"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_frame_err"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_over_err"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"rx_packets"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"tx_bytes"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"tx_dropped"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"tx_errors"</span>, <span class="number">0</span>],</div><div class="line">                    [<span class="string">"tx_packets"</span>, <span class="number">0</span>]</div><div class="line">                ]],</div><div class="line">                <span class="attr">"mac_in_use"</span>: <span class="string">"6e:2b:1b:5e:23:8f"</span>,</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"internal"</span>,</div><div class="line">                <span class="attr">"cfm_remote_opstate"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ingress_policing_rate"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"status"</span>: [<span class="string">"map"</span>, [</div><div class="line">                    [<span class="string">"driver_name"</span>, <span class="string">"openvswitch"</span>]</div><div class="line">                ]],</div><div class="line">                <span class="attr">"mac"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ofport"</span>: <span class="number">10</span>,</div><div class="line">                <span class="attr">"ifindex"</span>: <span class="number">22</span>,</div><div class="line">                <span class="attr">"cfm_fault_status"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"duplex"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"lacp_current"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"cfm_fault"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"bfd_status"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"link_state"</span>: <span class="string">"down"</span>,</div><div class="line">                <span class="attr">"admin_state"</span>: <span class="string">"down"</span>,</div><div class="line">                <span class="attr">"other_config"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"cfm_remote_mpids"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"ingress_policing_burst"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"ofport_request"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"bfd"</span>: [<span class="string">"map"</span>, []],</div><div class="line">                <span class="attr">"cfm_mpid"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"cfm_flap_count"</span>: [<span class="string">"set"</span>, []],</div><div class="line">                <span class="attr">"link_resets"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"cfm_health"</span>: [<span class="string">"set"</span>, []]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;]</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ovsdb协议&quot;&gt;&lt;a href=&quot;#ovsdb协议&quot; class=&quot;headerlink&quot; title=&quot;ovsdb协议&quot;&gt;&lt;/a&gt;ovsdb协议&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;基于json的RPC&lt;/li&gt;
&lt;li&gt;协议定义参考 &lt;a href=&quot;https://www.rfc-editor.org/rfc/rfc7047.txt&quot;&gt;https://www.rfc-editor.org/rfc/rfc7047.txt&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;当前ovsdb-server实现是单线程，性能很低，HA只有主备。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;client库&quot;&gt;&lt;a href=&quot;#client库&quot; class=&quot;headerlink&quot; title=&quot;client库&quot;&gt;&lt;/a&gt;client库&lt;/h2&gt;&lt;p&gt;自带 C 和 Python的。其他开源的库有&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;golang&lt;br&gt;&lt;code&gt;https://github.com/socketplane/libovsdb/blob/master/example/play_with_ovs.go&lt;/code&gt;&lt;br&gt;&lt;code&gt;https://github.com/contiv/ofnet/blob/master/ovsdbDriver/ovsdbDriver.go&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;python&lt;br&gt;ovsdbapp&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以下是一个ovsdbapp使用的例子，&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; ovsdbapp.backend.ovs_idl &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; connection&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; ovsdbapp &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; constants&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; ovsdbapp.schema.open_vswitch &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; impl_idl&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ovsdb_connection = connection.Connection(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    idl=connection.OvsdbIdl.from_server(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&#39;unix:/var/run/openvswitch/db.sock&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;Open_vSwitch&#39;&lt;/span&gt;),&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    timeout=constants.DEFAULT_TIMEOUT)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;api = impl_idl.OvsdbIdl(ovsdb_connection)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;result = api.br_exists(&lt;span class=&quot;string&quot;&gt;&quot;br0&quot;&lt;/span&gt;).execute(check_error=&lt;span class=&quot;keyword&quot;&gt;True&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;print&lt;/span&gt; result&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;result = api.del_br(&lt;span class=&quot;string&quot;&gt;&quot;br1&quot;&lt;/span&gt;).execute(check_error=&lt;span class=&quot;keyword&quot;&gt;True&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;print&lt;/span&gt; result&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;协议交互举例&quot;&gt;&lt;a href=&quot;#协议交互举例&quot; class=&quot;headerlink&quot; title=&quot;协议交互举例&quot;&gt;&lt;/a&gt;协议交互举例&lt;/h2&gt;&lt;p&gt;ovs-vsctl操作的是ovs db。ovs-vswitchd有monitor ovs db，ovs db的变更都会发到ovs-vswitchd。ovs-vsctl和ovs-vswitchd都是通过ovsdb-server进程（unix socket或者是tcp连接）去watch或者update db的。&lt;/p&gt;
&lt;p&gt;以&lt;code&gt;ovs-vsctl add-port br0 abc -- set interface abc type=internal&lt;/code&gt;为例，&lt;br&gt;ovs-vsctl会在ovsdb的Port表和Interface表增加一行数据，ovs-vswitchd收到通知后，会创建接口，并且把ofport，mtu，mac，link_state等信息写入Interface表里。写入是否成功呢，还是靠的监控通知机制。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ovs-vsctl -v&lt;/code&gt;可以打印出ovs-vsctl和ovsdb-server详细的json rpc交互过程。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ovsdb-client monitor tcp:127.0.0.1:6640 Interface name,ofport,external_ids --format=json&lt;/code&gt;这个命令可以watch某些表某些字段的变更通知：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. 初始时会把所有的内容返回来。
2. 以后只会返回变化的。
3. 注意，返回的action里有initial，delete, new不是实际协议的内容，这是处理过了的。协议里只有old和new。见rfc里的4.1.6里的解释。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ovs-vswitchd消息处理过程如下，&lt;/p&gt;
    
    </summary>
    
      <category term="ovn" scheme="http://blog.motitan.com/categories/ovn/"/>
    
      <category term="openvswitch" scheme="http://blog.motitan.com/categories/ovn/openvswitch/"/>
    
    
      <category term="openvswitch" scheme="http://blog.motitan.com/tags/openvswitch/"/>
    
      <category term="ovn" scheme="http://blog.motitan.com/tags/ovn/"/>
    
      <category term="ovs" scheme="http://blog.motitan.com/tags/ovs/"/>
    
      <category term="ovsdb" scheme="http://blog.motitan.com/tags/ovsdb/"/>
    
  </entry>
  
  <entry>
    <title>openstack-openvswitch流表学习</title>
    <link href="http://blog.motitan.com/2017/08/11/openstack-openvswitch%E6%B5%81%E8%A1%A8%E5%AD%A6%E4%B9%A0/"/>
    <id>http://blog.motitan.com/2017/08/11/openstack-openvswitch流表学习/</id>
    <published>2017-08-11T07:55:00.000Z</published>
    <updated>2017-08-15T09:39:39.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>openstack</code>版本是<code>ocata</code>，操作系统是<code>ubuntu 1604.3</code>。</p>
<h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p>逻辑架构图在这里</p>
<ul>
<li><a href="https://docs.openstack.org/ocata/networking-guide/deploy-ovs-selfservice.html#east-west-scenario-1-instances-on-the-same-network" target="_blank" rel="external">https://docs.openstack.org/ocata/networking-guide/deploy-ovs-selfservice.html#east-west-scenario-1-instances-on-the-same-network</a></li>
</ul>
<h2 id="flow分析"><a href="#flow分析" class="headerlink" title="flow分析"></a>flow分析</h2><p>这里只分析flow（<code>neutron</code>网络用的是<code>openvswitch+vxlan+local vlan</code>）</p>
<h3 id="br-int"><a href="#br-int" class="headerlink" title="br-int"></a>br-int</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">ovs-ofctl dump-flows br-int</div><div class="line"> cookie=0x8035824320e90178, duration=62019.739s, table=0, n_packets=0, n_bytes=0, idle_age=65534, priority=10,icmp6,in_port=2,icmp_type=136 actions=resubmit(,24)</div><div class="line"> cookie=0x8035824320e90178, duration=62019.721s, table=0, n_packets=0, n_bytes=0, idle_age=65534, priority=10,icmp6,in_port=3,icmp_type=136 actions=resubmit(,24)</div><div class="line"> cookie=0x8035824320e90178, duration=62019.734s, table=0, n_packets=24, n_bytes=1008, idle_age=28257, priority=10,arp,in_port=2 actions=resubmit(,24)</div><div class="line"> cookie=0x8035824320e90178, duration=62019.717s, table=0, n_packets=22, n_bytes=924, idle_age=2913, priority=10,arp,in_port=3 actions=resubmit(,24)</div><div class="line"> cookie=0x8035824320e90178, duration=62019.744s, table=0, n_packets=99, n_bytes=10196, idle_age=28262, priority=9,in_port=2 actions=resubmit(,25)</div><div class="line"> cookie=0x8035824320e90178, duration=62019.726s, table=0, n_packets=366, n_bytes=36340, idle_age=2918, priority=9,in_port=3 actions=resubmit(,25)</div><div class="line"> cookie=0x8035824320e90178, duration=62040.987s, table=0, n_packets=0, n_bytes=0, idle_age=65534, priority=2,in_port=1,dl_src=fa:16:3f:7d:c0:dd actions=resubmit(,1)</div><div class="line"> cookie=0x8035824320e90178, duration=62040.983s, table=0, n_packets=0, n_bytes=0, idle_age=65534, priority=2,in_port=1,dl_src=fa:16:3f:e9:2f:8a actions=resubmit(,1)</div><div class="line"> cookie=0x8035824320e90178, duration=62040.979s, table=0, n_packets=0, n_bytes=0, idle_age=65534, priority=2,in_port=1,dl_src=fa:16:3f:f4:6e:4d actions=resubmit(,1)</div><div class="line"> cookie=0x8035824320e90178, duration=62041.561s, table=0, n_packets=0, n_bytes=0, idle_age=65534, priority=0 actions=NORMAL</div><div class="line"> cookie=0x8035824320e90178, duration=62041.009s, table=0, n_packets=450, n_bytes=43915, idle_age=2912, priority=1 actions=NORMAL</div><div class="line"> cookie=0x8035824320e90178, duration=62041.013s, table=1, n_packets=0, n_bytes=0, idle_age=65534, priority=1 actions=drop</div><div class="line"> cookie=0x8035824320e90178, duration=62041.012s, table=2, n_packets=0, n_bytes=0, idle_age=65534, priority=1 actions=drop</div><div class="line"> cookie=0x8035824320e90178, duration=62041.015s, table=23, n_packets=0, n_bytes=0, idle_age=65534, priority=0 actions=drop</div><div class="line"> cookie=0x8035824320e90178, duration=62019.741s, table=24, n_packets=0, n_bytes=0, idle_age=62019, priority=2,icmp6,in_port=2,icmp_type=136,nd_target=fe80::f816:3eff:fe13:fea1 actions=NORMAL</div><div class="line"> cookie=0x8035824320e90178, duration=62019.723s, table=24, n_packets=0, n_bytes=0, idle_age=62019, priority=2,icmp6,in_port=3,icmp_type=136,nd_target=fe80::f816:3eff:fe1b:6be7 actions=NORMAL</div><div class="line"> cookie=0x8035824320e90178, duration=62019.736s, table=24, n_packets=2, n_bytes=84, idle_age=28257, priority=2,arp,in_port=2,arp_spa=192.0.2.3 actions=resubmit(,25)</div><div class="line"> cookie=0x8035824320e90178, duration=62019.719s, table=24, n_packets=20, n_bytes=840, idle_age=2913, priority=2,arp,in_port=3,arp_spa=192.0.2.10 actions=resubmit(,25)</div><div class="line"> cookie=0x8035824320e90178, duration=62041.560s, table=24, n_packets=0, n_bytes=0, idle_age=65534, priority=0 actions=drop</div><div class="line"> cookie=0x8035824320e90178, duration=62019.748s, table=25, n_packets=123, n_bytes=11204, idle_age=28257, priority=2,in_port=2,dl_src=fa:16:3e:13:fe:a1 actions=NORMAL</div><div class="line"> cookie=0x8035824320e90178, duration=62019.730s, table=25, n_packets=388, n_bytes=37264, idle_age=2913, priority=2,in_port=3,dl_src=fa:16:3e:1b:6b:e7 actions=NORMAL</div></pre></td></tr></table></figure>
<p>port=2和3是两个不同用户的虚机，port=1是patch-tun。<br>table=24 arp里的源IP和port验证。<br>table=25 源mac和port验证。<br>（&lt;端口，源ip，源mac&gt;的ipv4验证在iptables里）  </p>
<h3 id="br-tun"><a href="#br-tun" class="headerlink" title="br-tun"></a>br-tun</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">ovs-ofctl dump-flows br-tun</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.875s, table=0, n_packets=525, n_bytes=49584, idle_age=3801, priority=1,in_port=1 actions=resubmit(,1)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62913.324s, table=0, n_packets=287, n_bytes=26502, idle_age=3801, priority=1,in_port=3 actions=resubmit(,4)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.929s, table=0, n_packets=168, n_bytes=18211, idle_age=29027, priority=1,in_port=2 actions=resubmit(,4)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.985s, table=0, n_packets=0, n_bytes=0, idle_age=65534, priority=0 actions=drop</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.872s, table=1, n_packets=525, n_bytes=49584, idle_age=3801, priority=0 actions=resubmit(,2)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.983s, table=2, n_packets=27, n_bytes=1134, idle_age=4064, priority=1,arp,dl_dst=ff:ff:ff:ff:ff:ff actions=resubmit(,21)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.980s, table=2, n_packets=468, n_bytes=45046, idle_age=3801, priority=0,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,20)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.978s, table=2, n_packets=30, n_bytes=3404, idle_age=65534, priority=0,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,22)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.977s, table=3, n_packets=0, n_bytes=0, idle_age=65534, priority=0 actions=drop</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62927.265s, table=4, n_packets=64, n_bytes=7237, idle_age=29146, priority=1,tun_id=0x3f actions=mod_vlan_vid:1,resubmit(,9)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62927.257s, table=4, n_packets=366, n_bytes=35310, idle_age=3801, priority=1,tun_id=0x57 actions=mod_vlan_vid:2,resubmit(,9)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.975s, table=4, n_packets=25, n_bytes=2166, idle_age=63148, priority=0 actions=drop</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.974s, table=6, n_packets=0, n_bytes=0, idle_age=65534, priority=0 actions=drop</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.853s, table=9, n_packets=0, n_bytes=0, idle_age=65534, priority=1,dl_src=fa:16:3f:7d:c0:dd actions=output:1</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.849s, table=9, n_packets=0, n_bytes=0, idle_age=65534, priority=1,dl_src=fa:16:3f:e9:2f:8a actions=output:1</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.845s, table=9, n_packets=0, n_bytes=0, idle_age=65534, priority=1,dl_src=fa:16:3f:f4:6e:4d actions=output:1</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.873s, table=9, n_packets=430, n_bytes=42547, idle_age=3801, priority=0 actions=resubmit(,10)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.971s, table=10, n_packets=430, n_bytes=42547, idle_age=3801, priority=1 actions=learn(table=20,hard_timeout=300,priority=1,cookie=0xa3c68d</div><div class="line">f625ec7f59,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:0-&gt;NXM_OF_VLAN_TCI[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:OXM_OF_IN_PORT[]),output:1</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.916s, table=20, n_packets=92, n_bytes=9094, idle_age=29146, priority=2,dl_vlan=1,dl_dst=fa:16:3e:19:89:22 actions=strip_vlan,load:0x3f-&gt;NX</div><div class="line">M_NX_TUN_ID[],output:2</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.166s, table=20, n_packets=0, n_bytes=0, idle_age=63881, priority=2,dl_vlan=2,dl_dst=fa:16:3e:99:f0:a5 actions=strip_vlan,load:0x57-&gt;NXM_NX</div><div class="line">_TUN_ID[],output:3</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.161s, table=20, n_packets=275, n_bytes=25998, idle_age=3801, priority=2,dl_vlan=2,dl_dst=fa:16:3e:5c:4c:d8 actions=strip_vlan,load:0x57-&gt;N</div><div class="line">XM_NX_TUN_ID[],output:3</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.144s, table=20, n_packets=2, n_bytes=374, idle_age=29027, priority=2,dl_vlan=2,dl_dst=fa:16:3e:9a:b9:6f actions=strip_vlan,load:0x57-&gt;NXM_</div><div class="line">NX_TUN_ID[],output:2</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.139s, table=20, n_packets=0, n_bytes=0, idle_age=62907, priority=2,dl_vlan=2,dl_dst=fa:16:3e:0a:23:bd actions=strip_vlan,load:0x57-&gt;NXM_NX</div><div class="line">_TUN_ID[],output:2</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.970s, table=20, n_packets=0, n_bytes=0, idle_age=65534, priority=0 actions=resubmit(,22)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.918s, table=21, n_packets=2, n_bytes=84, idle_age=29151, priority=1,arp,dl_vlan=1,arp_tpa=192.0.2.2 actions=load:0x2-&gt;NXM_OF_ARP_OP[],move</div><div class="line">:NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],load:0xfa163e198922-&gt;NXM_NX_ARP_SHA[],load:0xc0000202-&gt;NXM_OF_ARP_SPA[],move:NXM_OF_ETH_SRC[]-&gt;NXM_OF_ETH</div><div class="line">_DST[],mod_dl_src:fa:16:3e:19:89:22,IN_PORT</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.168s, table=21, n_packets=0, n_bytes=0, idle_age=63881, priority=1,arp,dl_vlan=2,arp_tpa=192.0.2.9 actions=load:0x2-&gt;NXM_OF_ARP_OP[],move:</div><div class="line">NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],load:0xfa163e99f0a5-&gt;NXM_NX_ARP_SHA[],load:0xc0000209-&gt;NXM_OF_ARP_SPA[],move:NXM_OF_ETH_SRC[]-&gt;NXM_OF_ETH_</div><div class="line">DST[],mod_dl_src:fa:16:3e:99:f0:a5,IN_PORT</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.163s, table=21, n_packets=1, n_bytes=42, idle_age=4064, priority=1,arp,dl_vlan=2,arp_tpa=192.0.2.6 actions=load:0x2-&gt;NXM_OF_ARP_OP[],move:</div><div class="line">NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],load:0xfa163e5c4<span class="built_in">cd</span>8-&gt;NXM_NX_ARP_SHA[],load:0xc0000206-&gt;NXM_OF_ARP_SPA[],move:NXM_OF_ETH_SRC[]-&gt;NXM_OF_ETH_</div><div class="line">DST[],mod_dl_src:fa:16:3e:5c:4c:d8,IN_PORT</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.146s, table=21, n_packets=1, n_bytes=42, idle_age=29032, priority=1,arp,dl_vlan=2,arp_tpa=192.0.2.2 actions=load:0x2-&gt;NXM_OF_ARP_OP[],move</div><div class="line">:NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],load:0xfa163e9ab96f-&gt;NXM_NX_ARP_SHA[],load:0xc0000202-&gt;NXM_OF_ARP_SPA[],move:NXM_OF_ETH_SRC[]-&gt;NXM_OF_ETH</div><div class="line">_DST[],mod_dl_src:fa:16:3e:9a:b9:6f,IN_PORT</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.141s, table=21, n_packets=0, n_bytes=0, idle_age=62907, priority=1,arp,dl_vlan=2,arp_tpa=192.0.2.1 actions=load:0x2-&gt;NXM_OF_ARP_OP[],move:</div><div class="line">NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],load:0xfa163e0a23bd-&gt;NXM_NX_ARP_SHA[],load:0xc0000201-&gt;NXM_OF_ARP_SPA[],move:NXM_OF_ETH_SRC[]-&gt;NXM_OF_ETH_</div><div class="line">DST[],mod_dl_src:fa:16:3e:0a:23:bd,IN_PORT</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.968s, table=21, n_packets=21, n_bytes=882, idle_age=65534, priority=0 actions=resubmit(,22)</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.926s, table=22, n_packets=29, n_bytes=2026, idle_age=65534, priority=1,dl_vlan=1 actions=strip_vlan,load:0x3f-&gt;NXM_NX_TUN_ID[],output:2</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62907.158s, table=22, n_packets=8, n_bytes=1144, idle_age=65534, priority=1,dl_vlan=2 actions=strip_vlan,load:0x57-&gt;NXM_NX_TUN_ID[],output:2,out</div><div class="line">put:3</div><div class="line"> cookie=0xa3c68df625ec7f59, duration=62929.967s, table=22, n_packets=14, n_bytes=1116, idle_age=65534, priority=0 actions=drop</div></pre></td></tr></table></figure>
<p><code>port=1</code>是<code>patch-int</code>，port 2和3是vxlan接口，没有用通配tunnel。<br><code>table=0</code>是根据<code>in_port</code>分出向和入向。<br><code>table=2</code>是出向流表，按广播arp，单播，广播分发到table 21，20，22.<br><code>table=20</code>是明细的单播flow，送到目的（匹配带<code>vlan_id</code>）<br><code>table=21</code>是arp代答，然后默认转22<br><code>table=22</code>是广播flow，送到目的（匹配带<code>vlan_id</code>）<br><code>table=4</code>是入向，<code>tun_id</code>转成<code>vlan_id</code>，转table 9<br><code>table=9</code>，转<code>table 10</code><br><code>table=10</code>入向流表，同时有学习，在<code>table=20</code>的后面添加一条<code>priority=1</code>的对应出向的流表，类似于<code>cookie=0xa3c68df625ec7f59, duration=37.162s, table=20, n_packets=0, n_bytes=0, hard_timeout=300, idle_age=37, hard_age=0, priority=1,vlan_tci=0x0002/0x0fff,dl_dst=fa:16:3e:5c:4c:d8 actions=load:0-&gt;NXM_OF_VLAN_TCI[],load:0x57-&gt;NXM_NX_TUN_ID[],output:3</code>，其中已经有了<code>priority=2</code>一样的推送下去的flow。<br>这条规则在配置了<code>allowed-address-pair</code>（单网卡多IP，多MAC支持）里用到了mac的情况下会用到。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;&lt;code&gt;openstack&lt;/code&gt;版本是&lt;code&gt;ocata&lt;/code&gt;，操作系统是&lt;code&gt;ubuntu 1604.3&lt;/
    
    </summary>
    
      <category term="openstack" scheme="http://blog.motitan.com/categories/openstack/"/>
    
      <category term="openvswitch" scheme="http://blog.motitan.com/categories/openstack/openvswitch/"/>
    
    
      <category term="openvswitch" scheme="http://blog.motitan.com/tags/openvswitch/"/>
    
      <category term="openstack" scheme="http://blog.motitan.com/tags/openstack/"/>
    
      <category term="ovs" scheme="http://blog.motitan.com/tags/ovs/"/>
    
      <category term="flow" scheme="http://blog.motitan.com/tags/flow/"/>
    
  </entry>
  
  <entry>
    <title>python package and deploy</title>
    <link href="http://blog.motitan.com/2017/06/06/python-package-and-deploy/"/>
    <id>http://blog.motitan.com/2017/06/06/python-package-and-deploy/</id>
    <published>2017-06-06T07:55:00.000Z</published>
    <updated>2017-06-06T08:18:20.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>python 打包和部署对于开源项目来说，pip/pypi 就足够了。但是对于公司线上的程序部署，有各种包依赖关系，需要做到依赖包隔离，程序版本管理，部署方式一致化。使用 docker 是很流行，并且通用的方式。还有没有更轻量的方式呢？这就是本文将介绍的内容。</p>
<p>一般来说，一个公司的线上系统版本是一致的，随系统发行版本带的 python 版本也是一致的。如果要跑不同的 python 版本，docker 是一个选择。这里讨论版本一致的情况。</p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>用到了以下工具，</p>
<ul>
<li><a href="https://virtualenv.pypa.io/en/stable/" target="_blank" rel="external">virtualenv</a>，包隔离</li>
<li><a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">fpm</a>，打包工具，支持打包成 rpm/deb/osxpkg 等。</li>
</ul>
<p>用 virtualenv 来做依赖包隔离，包含了自己的程序和依赖的包；系统自带的包管理工具（centos 是 rpm）来做版本管理，实现包的更新，回退。</p>
<h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><h4 id="fpm-安装（centos6-下为例）"><a href="#fpm-安装（centos6-下为例）" class="headerlink" title="fpm 安装（centos6 下为例）"></a>fpm 安装（centos6 下为例）</h4><ul>
<li>安装 virtualenv-tools。<br><code>pip install virtualenv-tools</code></li>
<li>安装 ruby（&gt;=1.9.3），用到了 <a href="https://www.softwarecollections.org/en/" target="_blank" rel="external">scl</a>。<br><code>yum install rh-ruby23-ruby rh-ruby23-ruby-devel</code><br><code>scl enable rh-ruby23 bash</code></li>
<li>安装 fpm。<br><code>gem install fpm</code></li>
</ul>
<h4 id="python项目"><a href="#python项目" class="headerlink" title="python项目"></a>python项目</h4><p>可以参考 <a href="https://github.com/faicker/pychinadns" target="_blank" rel="external">pychinadns</a>，需要写 setup.py。</p>
<h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><p><code>fpm --verbose -f -v 0.1.0 -n flowcleaner -s virtualenv -t rpm --virtualenv-pypi http://mirrors.aliyun.com/pypi/simple flowcleaner/</code><br>-s 指定源类型，-t 指定目标类型，-n 指定包名，flowcleaner/ 是项目目录。<br>会把整个 virtualenv 的目录打包到rpm里，virtualenv 里包含了依赖的包。</p>
<h4 id="部署和运行"><a href="#部署和运行" class="headerlink" title="部署和运行"></a>部署和运行</h4><p>部署就是一个rpm包！跟标准的rpm包操作一样。</p>
<p>rpm 安装时，virtualenv 默认安装在 /usr/share/python 目录下。<br>执行<code>/usr/share/python/flowcleaner/bin/python xxx.py</code>来从 virtualenv 里运行。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;python 打包和部署对于开源项目来说，pip/pypi 就足够了。但是对于公司线上的程序部署，有各种包依赖关系，需要做到依赖包隔离，程序
    
    </summary>
    
      <category term="python" scheme="http://blog.motitan.com/categories/python/"/>
    
      <category term="deploy" scheme="http://blog.motitan.com/categories/python/deploy/"/>
    
    
      <category term="python" scheme="http://blog.motitan.com/tags/python/"/>
    
      <category term="virtualenv" scheme="http://blog.motitan.com/tags/virtualenv/"/>
    
      <category term="fpm" scheme="http://blog.motitan.com/tags/fpm/"/>
    
  </entry>
  
  <entry>
    <title>python性能分析工具之pyflame</title>
    <link href="http://blog.motitan.com/2017/04/15/python%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E4%B9%8Bpyflame/"/>
    <id>http://blog.motitan.com/2017/04/15/python性能分析工具之pyflame/</id>
    <published>2017-04-15T14:30:00.000Z</published>
    <updated>2017-04-16T04:01:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>这篇文章<a href="http://www.cnblogs.com/xybaby/p/6510941.html" target="_blank" rel="external">python性能优化</a>总结的比较好，可以先看这篇的介绍。</p>
<p>里面介绍了针对不同场景使用的工具，</p>
<blockquote>
<p>对于python程序，比较出名的profile工具有三个：profile、cprofile和hotshot。<br>其中profile是纯python语言实现的，Cprofile将profile的部分实现native化，hotshot也是C语言实现，hotshot与Cprofile的区别在于：hotshot对目标代码的运行影响较小，代价是更多的后处理时间，而且hotshot已经停止维护了。需要注意的是，profile（Cprofile hotshot）只适合单线程的python程序。<br>对于多线程，可以使用yappi，yappi不仅支持多线程，还可以精确到CPU时间<br>对于协程（greenlet），可以使用greenletprofiler，基于yappi修改，用greenlet context hook住thread context。</p>
</blockquote>
<p>profile的结果可以用<a href="https://github.com/jrfonseca/gprof2dot" target="_blank" rel="external">gprof2dot</a>生成函数调用开销图，进行分析。</p>
<p>这里介绍另外一个好用的工具pyflame。对单线程，多线程，协程支持都很好，使用简单，不用修改源码，直接profile运行的进程。效率较高，进程运行只会慢3倍左右，建议非线上环境使用。最最关键的是可以直接生成<a href="https://github.com/brendangregg/FlameGraph" target="_blank" rel="external">火焰图</a>，具体介绍可以看github链接<a href="https://github.com/uber/pyflame" target="_blank" rel="external">pyflame</a>。<br>火焰图怎么看先google学习下，比gprof2dot的图更清晰明了。</p>
<hr>
<p>pyflame的安装步骤在github上介绍的很详细，对centos7也是适用的。这里介绍下内核较老的centos6+python2.6下面的安装（是一个C API 缺失<a href="http://hustcat.github.io/setns/" target="_blank" rel="external">setns</a>）。<br><a id="more"></a></p>
<ol>
<li>下载源码，<code>git clone https://github.com/faicker/pyflame</code></li>
<li><p>安装编译环境（高版本gcc和autoconf）及依赖包，</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">yum install centos-release-scl</div><div class="line">yum install devtoolset-3-gcc devtoolset-3-gcc-c++</div><div class="line">rpm -ivh https://www.softwarecollections.org/en/scls/praiskup/autotools/epel-6-x86_64/download/praiskup-autotools-epel-6-x86_64.noarch.rpm</div><div class="line">yum install autotools-latest</div><div class="line">yum install python-devel</div></pre></td></tr></table></figure>
</li>
<li><p>编辑文件<code>/usr/lib64/pkgconfig/python2.pc</code></p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">prefix=/usr</div><div class="line">exec_prefix=/usr</div><div class="line">libdir=/usr/lib64</div><div class="line">includedir=/usr/include</div><div class="line">Name: Python</div><div class="line">Description: Python library</div><div class="line">Requires:</div><div class="line">Version: 2.6</div><div class="line">Libs.private: -lpthread -ldl  -lutil</div><div class="line">Libs: -L<span class="variable">$&#123;libdir&#125;</span> -lpython2.6</div><div class="line">Cflags: -I<span class="variable">$&#123;includedir&#125;</span>/python2.6</div></pre></td></tr></table></figure>
</li>
<li><p>编译，</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">scl <span class="built_in">enable</span> devtoolset-3 bash</div><div class="line">scl <span class="built_in">enable</span> autotools-latest bash</div><div class="line">./autogen.sh</div><div class="line">./configure</div><div class="line">make</div></pre></td></tr></table></figure>
</li>
</ol>
<p>Enjoy.</p>
<p>注意点：</p>
<ul>
<li>profile eventlet程序时，要把结果里出现次数最多（比采样次数还多）的tpool.py:tworker:75的堆栈删掉。</li>
<li>svg文件可以用浏览器比如chrome打开。</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这篇文章&lt;a href=&quot;http://www.cnblogs.com/xybaby/p/6510941.html&quot;&gt;python性能优化&lt;/a&gt;总结的比较好，可以先看这篇的介绍。&lt;/p&gt;
&lt;p&gt;里面介绍了针对不同场景使用的工具，&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;对于python程序，比较出名的profile工具有三个：profile、cprofile和hotshot。&lt;br&gt;其中profile是纯python语言实现的，Cprofile将profile的部分实现native化，hotshot也是C语言实现，hotshot与Cprofile的区别在于：hotshot对目标代码的运行影响较小，代价是更多的后处理时间，而且hotshot已经停止维护了。需要注意的是，profile（Cprofile hotshot）只适合单线程的python程序。&lt;br&gt;对于多线程，可以使用yappi，yappi不仅支持多线程，还可以精确到CPU时间&lt;br&gt;对于协程（greenlet），可以使用greenletprofiler，基于yappi修改，用greenlet context hook住thread context。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;profile的结果可以用&lt;a href=&quot;https://github.com/jrfonseca/gprof2dot&quot;&gt;gprof2dot&lt;/a&gt;生成函数调用开销图，进行分析。&lt;/p&gt;
&lt;p&gt;这里介绍另外一个好用的工具pyflame。对单线程，多线程，协程支持都很好，使用简单，不用修改源码，直接profile运行的进程。效率较高，进程运行只会慢3倍左右，建议非线上环境使用。最最关键的是可以直接生成&lt;a href=&quot;https://github.com/brendangregg/FlameGraph&quot;&gt;火焰图&lt;/a&gt;，具体介绍可以看github链接&lt;a href=&quot;https://github.com/uber/pyflame&quot;&gt;pyflame&lt;/a&gt;。&lt;br&gt;火焰图怎么看先google学习下，比gprof2dot的图更清晰明了。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;pyflame的安装步骤在github上介绍的很详细，对centos7也是适用的。这里介绍下内核较老的centos6+python2.6下面的安装（是一个C API 缺失&lt;a href=&quot;http://hustcat.github.io/setns/&quot;&gt;setns&lt;/a&gt;）。&lt;br&gt;
    
    </summary>
    
      <category term="python" scheme="http://blog.motitan.com/categories/python/"/>
    
      <category term="pyflame" scheme="http://blog.motitan.com/categories/python/pyflame/"/>
    
      <category term="profile" scheme="http://blog.motitan.com/categories/python/pyflame/profile/"/>
    
    
      <category term="python" scheme="http://blog.motitan.com/tags/python/"/>
    
      <category term="pyflame" scheme="http://blog.motitan.com/tags/pyflame/"/>
    
      <category term="profile" scheme="http://blog.motitan.com/tags/profile/"/>
    
  </entry>
  
  <entry>
    <title>install openvswitch 2.7.0 and ovn on centos 7</title>
    <link href="http://blog.motitan.com/2017/03/11/install-openvswitch2.7.0-and-ovn-on-centos7/"/>
    <id>http://blog.motitan.com/2017/03/11/install-openvswitch2.7.0-and-ovn-on-centos7/</id>
    <published>2017-03-11T03:55:00.000Z</published>
    <updated>2017-03-11T04:31:30.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>主要参考此安装文档 <a href="http://docs.openvswitch.org/en/latest/intro/install/fedora/" target="_blank" rel="external">http://docs.openvswitch.org/en/latest/intro/install/fedora/</a><br>不过此文档只适用于fedora。</p>
<h3 id="rpm编译"><a href="#rpm编译" class="headerlink" title="rpm编译"></a>rpm编译</h3><p>在centos7上编译过程如下：</p>
<ol>
<li><p>安装依赖包</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install rpm-build autoconf automake libtool systemd-units openssl openssl-devel python-devel groff graphviz desktop-file-utils python-twisted python-zope-interface python-six procps-ng checkpolicy selinux-policy-devel libcap-ng libcap-ng-devel</div></pre></td></tr></table></figure>
</li>
<li><p>安装额外的依赖包python3-devel。</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rpm -ivh http://li.nux.ro/download/nux/dextop/el7/x86_64/nux-dextop-release-0-5.el7.nux.noarch.rpm</div><div class="line">yum install python3-devel</div></pre></td></tr></table></figure>
</li>
<li><p>如果要支持ovs-dpdk，</p>
<ul>
<li>安装dpdk 16.11，rpm包地址 <a href="[https://cbs.centos.org/koji/buildinfo?buildID=15283">https://cbs.centos.org/koji/buildinfo?buildID=15283</a></li>
<li><code>yum install numactl-devel libpcap-devel</code></li>
</ul>
</li>
<li><p>初始化环境</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tar xf openvswitch-2.7.0.tar.gz</div><div class="line"><span class="built_in">cd</span> openvswitch-2.7.0</div><div class="line">./boot.sh</div><div class="line">./configure --prefix=/usr --localstatedir=/var --sysconfdir=/etc</div></pre></td></tr></table></figure>
</li>
<li><p>生成用户态rpm包，</p>
<ul>
<li><p>如果不需要dpdk，把–with dpdk去掉。同时，这里去掉了测试。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make rpm-fedora RPMBUILD_OPT=<span class="string">"--with dpdk --without check"</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>生成内核态rpm包，</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make rpm-fedora-kmod</div></pre></td></tr></table></figure>
</li>
</ol>
<p>生成的包在<code>rpm/rpmbuild/RPMS</code>下，包括ovn相关的。如果只想体验ovs，安装<code>openvswitch-2.7.0-1.el7.centos.x86_64.rpm</code>和<code>openvswitch-kmod-2.7.0-1.el7.centos.x86_64.rpm</code>即可。</p>
<h3 id="rpm安装时的注意事项"><a href="#rpm安装时的注意事项" class="headerlink" title="rpm安装时的注意事项"></a>rpm安装时的注意事项</h3><ul>
<li>如果安装rpm时，提示没有依赖包<code>python2-six/python2-twisted/python2-zope-interface</code>，加参数<code>--nodep</code>跳过依赖（前面其实已经安装了<code>python-six</code>等）</li>
<li><code>openvswitch-ovn</code>依赖<code>firewalld-filesystem</code>，通过<code>yum install firewalld-filesystem</code>安装。</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;主要参考此安装文档 &lt;a href=&quot;http://docs.openvswitch.org/en/latest/intro/install
    
    </summary>
    
      <category term="openvswitch" scheme="http://blog.motitan.com/categories/openvswitch/"/>
    
      <category term="ovn" scheme="http://blog.motitan.com/categories/openvswitch/ovn/"/>
    
    
      <category term="openvswitch" scheme="http://blog.motitan.com/tags/openvswitch/"/>
    
      <category term="ovn" scheme="http://blog.motitan.com/tags/ovn/"/>
    
      <category term="centos7" scheme="http://blog.motitan.com/tags/centos7/"/>
    
  </entry>
  
  <entry>
    <title>enable trim of yosemite</title>
    <link href="http://blog.motitan.com/2014/10/19/enable-trim-of-yosemite/"/>
    <id>http://blog.motitan.com/2014/10/19/enable-trim-of-yosemite/</id>
    <published>2014-10-19T12:47:41.000Z</published>
    <updated>2017-03-11T02:10:48.000Z</updated>
    
    <content type="html"><![CDATA[<p>步骤在这里，<a href="https://gist.github.com/return1/4058659" target="_blank" rel="external">https://gist.github.com/return1/4058659</a></p>
<p><code>yosemite</code>, <code>MBP 2011 early</code>，三星<code>ssd 840 evo</code>亲测开启成功。</p>
<p>命令一句一句贴到<code>terminal</code>里执行。中间会重启2次。</p>
<p><code>yosemite</code>里有一个新的安全设置<code>kext signing</code>。如果驱动被修改，没有签名，系统将拒绝载入这个驱动，开机报错。<br>现在的方法是关闭<code>kext signing</code>机制，这个配置是存在<code>NVRAM/PRAM</code>的。关闭全局<code>kext signing</code>是有安全风险的。</p>
<p>开启成功后，如果以后重置了<code>NVRAM/PRAM</code>，会导致开不了机，切记。所以在重置前，需要先关闭<code>trim</code>。</p>
<p>详细的参考，包括开机报错怎么回退，</p>
<ul>
<li><a href="http://www.cindori.org/trim-enabler-and-yosemite/" target="_blank" rel="external">http://www.cindori.org/trim-enabler-and-yosemite/</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;步骤在这里，&lt;a href=&quot;https://gist.github.com/return1/4058659&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://gist.github.com/return1/4058659&lt;/a&gt;&lt;/p&gt;
&lt;p
    
    </summary>
    
      <category term="Mac OS X" scheme="http://blog.motitan.com/categories/Mac-OS-X/"/>
    
    
      <category term="Mac OS X" scheme="http://blog.motitan.com/tags/Mac-OS-X/"/>
    
      <category term="trim" scheme="http://blog.motitan.com/tags/trim/"/>
    
      <category term="yosemite" scheme="http://blog.motitan.com/tags/yosemite/"/>
    
  </entry>
  
  <entry>
    <title>用pylint(pyreverse)生成python代码的uml类图</title>
    <link href="http://blog.motitan.com/2014/09/21/generate-uml-of-python-code-with-pylint-pyreverse/"/>
    <id>http://blog.motitan.com/2014/09/21/generate-uml-of-python-code-with-pylint-pyreverse/</id>
    <published>2014-09-21T14:39:42.000Z</published>
    <updated>2017-03-11T04:33:07.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="pyreverse"><a href="#pyreverse" class="headerlink" title="pyreverse"></a>pyreverse</h2><p><code>pyreverse</code>能方便的生成uml类图，<code>pylint</code>里自带了<code>pyreverse</code>这个工具。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol>
<li>先安装graphviz</li>
<li>pip install pylint</li>
</ol>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pyreverse -ASmy -o png /System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/SocketServer.py -p SocketServer</div></pre></td></tr></table></figure>
<h3 id="图片示例"><a href="#图片示例" class="headerlink" title="图片示例"></a>图片示例</h3><a id="more"></a>
<p><img src="http://faicker.qiniudn.com/classes_SocketServer.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;pyreverse&quot;&gt;&lt;a href=&quot;#pyreverse&quot; class=&quot;headerlink&quot; title=&quot;pyreverse&quot;&gt;&lt;/a&gt;pyreverse&lt;/h2&gt;&lt;p&gt;&lt;code&gt;pyreverse&lt;/code&gt;能方便的生成uml类图，&lt;code&gt;pylint&lt;/code&gt;里自带了&lt;code&gt;pyreverse&lt;/code&gt;这个工具。&lt;/p&gt;
&lt;h3 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;先安装graphviz&lt;/li&gt;
&lt;li&gt;pip install pylint&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;使用&quot;&gt;&lt;a href=&quot;#使用&quot; class=&quot;headerlink&quot; title=&quot;使用&quot;&gt;&lt;/a&gt;使用&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;pyreverse -ASmy -o png /System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/SocketServer.py -p SocketServer&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;图片示例&quot;&gt;&lt;a href=&quot;#图片示例&quot; class=&quot;headerlink&quot; title=&quot;图片示例&quot;&gt;&lt;/a&gt;图片示例&lt;/h3&gt;
    
    </summary>
    
      <category term="python" scheme="http://blog.motitan.com/categories/python/"/>
    
    
      <category term="python" scheme="http://blog.motitan.com/tags/python/"/>
    
      <category term="uml" scheme="http://blog.motitan.com/tags/uml/"/>
    
      <category term="pylint" scheme="http://blog.motitan.com/tags/pylint/"/>
    
  </entry>
  
  <entry>
    <title>用nginx和heroku实现一个免费的http proxy</title>
    <link href="http://blog.motitan.com/2014/09/14/%E7%94%A8nginx%E5%92%8Cheroku%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%85%8D%E8%B4%B9%E7%9A%84http-proxy/"/>
    <id>http://blog.motitan.com/2014/09/14/用nginx和heroku实现一个免费的http-proxy/</id>
    <published>2014-09-14T15:24:03.000Z</published>
    <updated>2017-03-11T02:35:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>用nginx做forward proxy，借助于免费又支持SSL的heroku app，实现http proxy。</p>
<p>首先申请一个免费的heroku app做测试，heroku会分配一个域名，比如<code>xxx.herokuapp.com</code>，同时还支持SSL访问，这个是关键。</p>
<p>heroku的app不能直接用作代理，因为访问heroku app大概路径是，<br><code>xxx.herokuapp.com</code>解析到了heroku的前端nginx集群，然后再反向代理到自己的app。nginx会检查Host是否是heroku的app，不是的话会报404  Object Not Found。</p>
<p>思路是，</p>
<p>把要访问的网站嵌入到url里，比如<code>http://xxx.herokuapp.com/p/www.google.com</code>，然后我们在app里去请求www.google.com，然后把结果返回（包括response headers），这样我们访问<code>http://xxx.herokuapp.com/p/www.google.com</code>返回了google的内容！可以把这个app强化一下，处理一下refer，url等，完全就是heroku app的壳，里面套了其他网站的内容。</p>
<p>为了偷懒，简化这里的处理，可以在本地用nginx做一个forward proxy，把header里的host rewrite到url里。（开始是用flask写的一个程序做这个事情，后来发现还是nginx简单）</p>
<p>最后在浏览器里配置一下http proxy就行了。</p>
<p>PS,</p>
<p>heroku的免费app比较坑爹的地方是，如果一段时间inactive后，会自动关闭。</p>
<p>最后奉上nginx的配置和示例代码：<br><a id="more"></a><br>nginx server段配置如下，其他省略，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       8080;</div><div class="line">    location / &#123;</div><div class="line">        resolver 223.5.5.5;</div><div class="line">        proxy_pass https://xxx.herokuapp.com/p/$http_host$uri$is_args$args;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>app.py用的flask（网络上搜索到的一个例子改了一点，用其他也是OK的）</p>
<p>cat Procfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">web: python app.py</div></pre></td></tr></table></figure>
<p>cat requirements.txt（flask已经有新版本了）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Flask==0.9</div><div class="line">Jinja2==2.6</div><div class="line">Werkzeug==0.8.3</div><div class="line">wsgiref==0.1.2</div><div class="line">requests==2.3.0</div></pre></td></tr></table></figure>
<p>cat app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="string">"""</span></div><div class="line">A simple proxy server. Usage:</div><div class="line">http://hostname:port/p/(URL to be proxied, minus protocol)</div><div class="line">For example:</div><div class="line">http://localhost:8080/p/www.google.com</div><div class="line">"""</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, abort, Response, redirect</div><div class="line"><span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> WSGIRequestHandler</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"></div><div class="line">app = Flask(__name__.split(<span class="string">'.'</span>)[<span class="number">0</span>])</div><div class="line">logging.basicConfig(level=logging.INFO)</div><div class="line">LOG = logging.getLogger(<span class="string">"main.py"</span>)</div><div class="line"></div><div class="line"><span class="meta">@app.route('/&lt;path:url&gt;')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">root</span><span class="params">(url)</span>:</span></div><div class="line">    LOG.info(<span class="string">"Root route, path: %s"</span>, url)</div><div class="line">    <span class="comment"># If referred from a proxy request, then redirect to a URL with the proxy prefix.</span></div><div class="line">    <span class="comment"># This allows server-relative and protocol-relative URLs to work.</span></div><div class="line">    proxy_ref = proxy_ref_info(request)</div><div class="line">    <span class="keyword">if</span> proxy_ref:</div><div class="line">        redirect_url = <span class="string">"%s/%s%s"</span> % (proxy_ref[<span class="number">0</span>], url, (<span class="string">"?"</span> + request.query_string <span class="keyword">if</span> request.query_string <span class="keyword">else</span> <span class="string">""</span>))</div><div class="line">        LOG.info(<span class="string">"Redirecting referred URL to: %s"</span>, redirect_url)</div><div class="line">        <span class="keyword">return</span> proxy(redirect_url)</div><div class="line">    abort(<span class="number">404</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.route('/p/&lt;path:url&gt;')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">proxy</span><span class="params">(url)</span>:</span></div><div class="line">    <span class="string">"""Fetches the specified URL and streams it out to the client.</span></div><div class="line"></div><div class="line">    If the request was referred by the proxy itself (e.g. this is an image fetch for</div><div class="line">    a previously proxied HTML page), then the original Referer is passed."""</div><div class="line">    r = get_source_rsp(url)</div><div class="line">    LOG.info(<span class="string">"Got %s response from %s"</span>,r.status_code, url)</div><div class="line">    headers = dict(r.headers)</div><div class="line">    <span class="keyword">if</span> headers.has_key(<span class="string">'transfer-encoding'</span>):</div><div class="line">        <span class="keyword">del</span>(headers[<span class="string">'transfer-encoding'</span>])</div><div class="line">    <span class="keyword">if</span> headers.has_key(<span class="string">'content-encoding'</span>):</div><div class="line">        <span class="keyword">del</span>(headers[<span class="string">'content-encoding'</span>])</div><div class="line">    <span class="keyword">return</span> Response(r.content, headers = headers)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_source_rsp</span><span class="params">(url)</span>:</span></div><div class="line">        url = <span class="string">'http://%s'</span> % url</div><div class="line">        LOG.info(<span class="string">"Fetching %s"</span>, url)</div><div class="line">        <span class="comment"># Pass original Referer for subsequent resource requests</span></div><div class="line">        proxy_ref = proxy_ref_info(request)</div><div class="line">        headers = &#123; <span class="string">"Referer"</span> : <span class="string">"http://%s/%s"</span> % (proxy_ref[<span class="number">0</span>], proxy_ref[<span class="number">1</span>])&#125; <span class="keyword">if</span> proxy_ref <span class="keyword">else</span> &#123;&#125;</div><div class="line">        <span class="comment"># Fetch the URL, and stream it back</span></div><div class="line">        LOG.info(<span class="string">"Fetching with headers: %s, %s"</span>, url, headers)</div><div class="line">        <span class="keyword">return</span> requests.get(url, stream=<span class="keyword">False</span>, params = request.args, headers=headers)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">split_url</span><span class="params">(url)</span>:</span></div><div class="line">    <span class="string">"""Splits the given URL into a tuple of (protocol, host, uri)"""</span></div><div class="line">    proto, rest = url.split(<span class="string">':'</span>, <span class="number">1</span>)</div><div class="line">    rest = rest[<span class="number">2</span>:].split(<span class="string">'/'</span>, <span class="number">1</span>)</div><div class="line">    host, uri = (rest[<span class="number">0</span>], rest[<span class="number">1</span>]) <span class="keyword">if</span> len(rest) == <span class="number">2</span> <span class="keyword">else</span> (rest[<span class="number">0</span>], <span class="string">""</span>)</div><div class="line">    <span class="keyword">return</span> (proto, host, uri)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">proxy_ref_info</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="string">"""Parses out Referer info indicating the request is from a previously proxied page.</span></div><div class="line"></div><div class="line">    For example, if:</div><div class="line">        Referer: http://localhost:8080/p/google.com/search?q=foo</div><div class="line">    then the result is:</div><div class="line">        ("google.com", "search?q=foo")</div><div class="line">    """</div><div class="line">    ref = request.headers.get(<span class="string">'referer'</span>)</div><div class="line">    <span class="keyword">if</span> ref:</div><div class="line">        _, _, uri = split_url(ref)</div><div class="line">        <span class="keyword">if</span> uri.find(<span class="string">"/"</span>) &lt; <span class="number">0</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        first, rest = uri.split(<span class="string">"/"</span>, <span class="number">1</span>)</div><div class="line">        <span class="keyword">if</span> first <span class="keyword">in</span> <span class="string">"pd"</span>:</div><div class="line">            parts = rest.split(<span class="string">"/"</span>, <span class="number">1</span>)</div><div class="line">            r = (parts[<span class="number">0</span>], parts[<span class="number">1</span>]) <span class="keyword">if</span> len(parts) == <span class="number">2</span> <span class="keyword">else</span> (parts[<span class="number">0</span>], <span class="string">""</span>)</div><div class="line">            LOG.info(<span class="string">"Referred by proxy host, uri: %s, %s"</span>, r[<span class="number">0</span>], r[<span class="number">1</span>])</div><div class="line">            <span class="keyword">return</span> r</div><div class="line">    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    <span class="comment"># Bind to PORT if defined, otherwise default to 5000.</span></div><div class="line">    port = int(os.environ.get(<span class="string">'PORT'</span>, <span class="number">5000</span>))</div><div class="line">    WSGIRequestHandler.protocol_version = <span class="string">"HTTP/1.1"</span></div><div class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=port, threaded=<span class="keyword">True</span>)</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;用nginx做forward proxy，借助于免费又支持SSL的heroku app，实现http proxy。&lt;/p&gt;
&lt;p&gt;首先申请一个免费的heroku app做测试，heroku会分配一个域名，比如&lt;code&gt;xxx.herokuapp.com&lt;/code&gt;，同时还支持SSL访问，这个是关键。&lt;/p&gt;
&lt;p&gt;heroku的app不能直接用作代理，因为访问heroku app大概路径是，&lt;br&gt;&lt;code&gt;xxx.herokuapp.com&lt;/code&gt;解析到了heroku的前端nginx集群，然后再反向代理到自己的app。nginx会检查Host是否是heroku的app，不是的话会报404  Object Not Found。&lt;/p&gt;
&lt;p&gt;思路是，&lt;/p&gt;
&lt;p&gt;把要访问的网站嵌入到url里，比如&lt;code&gt;http://xxx.herokuapp.com/p/www.google.com&lt;/code&gt;，然后我们在app里去请求www.google.com，然后把结果返回（包括response headers），这样我们访问&lt;code&gt;http://xxx.herokuapp.com/p/www.google.com&lt;/code&gt;返回了google的内容！可以把这个app强化一下，处理一下refer，url等，完全就是heroku app的壳，里面套了其他网站的内容。&lt;/p&gt;
&lt;p&gt;为了偷懒，简化这里的处理，可以在本地用nginx做一个forward proxy，把header里的host rewrite到url里。（开始是用flask写的一个程序做这个事情，后来发现还是nginx简单）&lt;/p&gt;
&lt;p&gt;最后在浏览器里配置一下http proxy就行了。&lt;/p&gt;
&lt;p&gt;PS,&lt;/p&gt;
&lt;p&gt;heroku的免费app比较坑爹的地方是，如果一段时间inactive后，会自动关闭。&lt;/p&gt;
&lt;p&gt;最后奉上nginx的配置和示例代码：&lt;br&gt;
    
    </summary>
    
      <category term="proxy" scheme="http://blog.motitan.com/categories/proxy/"/>
    
    
      <category term="nginx" scheme="http://blog.motitan.com/tags/nginx/"/>
    
      <category term="heroku" scheme="http://blog.motitan.com/tags/heroku/"/>
    
      <category term="http proxy" scheme="http://blog.motitan.com/tags/http-proxy/"/>
    
  </entry>
  
</feed>
